## IPv4

Internet Protocol Version 4（互联网协议第4版）

### 地址格式

IPv4的地址长度为32位（4字节），通常表现为点分十进制格式，即以8位为一分组，每个分组写成十进制数，中间用点分隔，如192.0.2.235。

通过子网掩码将某个IPv4地址划分成网络地址和主机地址两部分，使用IPv4地址加一个斜杠后面跟子网掩码的点分十进制或子网掩码1的位数来表示属于某个子网的IPv4地址，如192.168.1.17/255.255.255.240或192.168.1.17/28。在同一个子网有两个特殊的地址，第0个主机号为网段地址，最后一个主机号为广播地址，如192.168.1.17/28这个主机地址所在的网段为192.168.1.16/28，广播地址为192.168.1.31。

### 特殊用途的地址

| 地址           | 描述                                                         |
| -------------- | ------------------------------------------------------------ |
| 0.0.0.0/0      | 任意地址，匹配所有地址                                       |
| 10.0.0.0/8     | 专用地址，即局域网地址                                       |
| 127.0.0.0/8    | 本地环回地址                                                 |
| 169.254.0.0/16 | 链路本地地址，主要被用于当主机不能从DHCP服务器获得IP地址时，自动生成的地址，只能与同一个链路上的结点进行通信，不能跨VLAN。 |
| 172.16.0.0/12  | 专用地址，即局域网地址                                       |
| 192.168.0.0/16 | 专用地址，即局域网地址                                       |
| 224.0.0.0/4    | 组播地址                                                     |

## IPv6

Internet Protocol Version 6（互联网协议第6版）。

### 地址格式

IPv6的地址长度为128位（16字节），通常表现为冒号分十六进制格式，即以16位为一分组，每个分组写成十六进制数，中间用冒号分隔，如ABCD:EF01:2345:6789:ABCD:EF01:2345:6789。IPv6地址中间如果包含很长一段0，可以把连续的一段0压缩为”::”，但为保证地址解析的唯一性，地址中”::”只能出现一次，如FF01:0:0:0:0:0:0:1101可压缩成FF01::1101。

为了实现IPv4-IPv6互通，IPv4地址会嵌入IPv6地址中，此时地址常表示为X:X:X:X:X:X:d.d.d.d，前96位采用冒分十六进制表示，而最后32位则使用IPv4的点分十进制表示，如::FFFF:192.168.0.1。

IPv6地址中具有固定的位数来标识网络，也称为IPv6前缀，如21DA:D3::/48。

### 特殊用途的地址

| 地址      | 描述                                                         |
| --------- | ------------------------------------------------------------ |
| ::/0      | 任意地址，匹配所有地址                                       |
| ::1/128   | 本地环回地址                                                 |
| FE80::/10 | 链路本地地址，自动生成的地址，只能与同一个链路上的结点进行通信，不能跨VLAN。每个接口上至少要有一个链路本地地址。 |
| FC00::/7  | 唯一本地地址、Unique Local Address、ULA，主要使用FD00::/8，类似于IPv4中的专用地址。 |
| FEC0::/10 | 站点本地地址（已弃用，被唯一本地地址代替）                   |
| FF00::/8  | 组播地址                                                     |

## ARP

Address Resolution Protocol（地址解析协议），是根据IP地址获取MAC地址的一个TCP/IP协议，**仅适用于IPv4**。

### 工作过程

1. 主机A在自己的本地ARP缓存中检查主机B的匹配MAC地址。如果找到映射，则结束。
2. 如果主机A在本地ARP缓存中没有找到映射，将源主机A的IP和MAC地址以及目标主机B的IP地址包含在ARP请求中，广播到子网上的所有主机，每台主机都接收到ARP请求并且检查是否与自己的IP地址匹配。如果主机发现请求的IP地址与自己的IP地址不匹配，将丢弃ARP请求。
3. 主机B确定ARP请求中的IP地址与自己的IP地址匹配，则将主机A的IP和MAC地址映射添加到本地ARP缓存中。
4. 主机B将包含其MAC地址的ARP回复消息**直接**发送回主机A。
5. 当主机A收到从主机B发来的ARP回复消息时，会用主机B的IP和MAC地址映射更新ARP缓存，并保留一段时间。

### 常用命令

Linux：

`arp -a`

查看本地缓存中所有的ARP项目。

`arp -i eth0`

查看本地缓存中eth0接口的ARP项目。

Windows：

`arp -a`

查看本地缓存中所有的ARP项目。

## VLAN

Virtual Local Area Network（虚拟局域网），是一种将局域网（LAN）设备从逻辑上划分（注意，不是从物理上划分）成一个个网段（或者说是更小的局域网LAN），从而实现虚拟工作组（单元）的数据交换技术。VLAN为局域网解决冲突域、广播域、带宽问题，可以提高性能和安全性。不同VLAN间互相通信时需要用到路由功能。

### VID与PVID/VLAN ID

VID：VLAN ID（VLAN编号），一个端口可以有多个VLAN，那么就有多个VID。

PVID：Port-base VLAN ID（基于端口的VLAN ID），代表端口的缺省VLAN，一般默认是1，一个端口只能有一个PVID，收到一个不带tag头的数据包时，会打上PVID所表示的VLAN号，视同该VLAN的数据包处理。

### tag端口与untag端口

tag端口和untag端口是针对某个VLAN而言，不是针对某个物理端口，一个物理端口可以对VLAN1是tag端口同时又对VLAN2是untag端口的。

接收数据包时，tag端口和untag端口，对于不带VLAN ID的数据包，都会打上该物理端口的PVID；对于带VLAN ID的数据包，都只允许在该物理端口的VLAN ID列表中的数据包通过。发送数据包时，tag端口会保留除PVID之外的VLAN ID，untag口总是会去掉VLAN ID。

### Access端口、Trunk端口与Hybrid端口

Access端口、Trunk端口与Hybrid端口都是指物理端口。

Access端口：只能属于一个VLAN，PVID和VID是一致的，一般用于连接计算机。发送数据包时，会去掉VLAN ID。

Trunk端口：属于多个VLAN，允许多个VLAN的数据包通过，一般用于连接两台交换机。发送数据包时，如果VID与PVID相同，则去掉VLAN ID；如果VID与PVID不同，则保留原有的VLAN ID。

Hybrid端口：属于多个VLAN，允许多个VLAN的数据包通过，一般较少使用。发送数据包时，可控制是否保留VLAN ID。

## Routing

路由最主要的作用就是实现跨网段的数据传输与转发，从一个接口上收到数据包，根据数据包的目的地址和路由表记录的转发规则进行定向并转发到另一个接口。

当连接到局域网时，默认情况下自动配置了该局域网网段的路由规则，因此可以访问该局域网中的其他主机。其实只要配置好路由规则，在同一链路上不同网段的任何和两个主机都可以相互访问。

### 路由表项

| 输出项      | 描述                                                         |
| ----------- | ------------------------------------------------------------ |
| Destination | 目的地址，用来标识IP包的目的网段或目的地址，0.0.0.0表示匹配所有地址。如果同时匹配多个目的地址，则优先匹配更精确的规则。 |
| Gateway     | 网关地址，也叫下一跳地址，0.0.0.0 表示目标是主机所属的网络，不需要路由。 |
| Genmask     | 网络掩码，与目的地址一起标识目的主机或者路由器所在的网段的地址。 |
| Iface       | 输出接口，说明IP包将哪个接口转发                             |
| Flags       | 标记。U：路由是活动的；H：目标是一个主机；G：路由指向网关    |

### 常用命令

Linux：

`ip route`、`ip -6 route`、`route -n`、`route -6 -n`

查看IPv4或IPv6路由表。

`route add -net 172.17.240.0/20 gw 192.168.0.7`、`route add -host 172.40.252.169 gw 192.168.0.7`

添加目的网段或目的地址的路由项。

`traceroute www.bilibili.com`

查看中途经过了哪些路由。

Windows：

`route print`

查看路由表。

`tracert www.bilibili.com`

查看中途经过了哪些路由。

## NAT

Network Address Translation（网络地址转换），IP包经过NAT设备时，将IP包中的源IP或目的IP进行转换，可以内转外，也可以外转内。 NAT设备维护一个状态表，用来把非法的IP地址映射到合法的IP地址上去。每个包在NAT设备中都被翻译成正确的IP地址，发往下一级。NAT设备会淘汰NAT表在一段时间内没有数据通讯的对应项，造成链路中断，超时时间并不一定，但可以使用心跳包维持连接。

### 实现方式

1. Static NAT：静态地址转换（ 一对一 ），将内部IP地址转换为外部IP地址，IP地址对是一对一的，是一直不变的。
2. Dynamic NAT：动态地址转换（ 多对多），将内部IP地址转换为外部IP地址，IP地址是不确定，随机的。配置一个外部IP地址池，当内部有主机需要和外部通信时，就从地址池里动态的取出一个外部IP，并将他们的对应关系绑定到NAT表中，通信结束后，这个外部IP才被释放，可供其他内部IP地址转换使用。
3. NAPT（Network Address Port Translation）或PAT（Port address Translation）：网络地址端口转换（ 多对一），改变外出数据包的源端口并进行端口转换，采用端口多路复用方式。内部网络的所有主机均可共享一个合法外部IP地址实现对Internet的访问，可以最大限度地节约IP地址资源。

### 转换方式

1. Full Cone NAT：完全锥形NAT，将内部的IP和端口映射到外部IP和端口，且无论目的地址是否相同，同一个内部的IP和端口会被映射为相同的外部IP和端口，外部的任何主机都可以通过映射后的IP和端口发送消息。

   例如：主机A（192.168.0.123:4000）访问主机B，A的IP将会被映射为（222.123.12.23:50000)；当主机A使用4000端口访问主机C时，同样会被映射为（222.123.12.23:50000)；而且此时任何主机C 、D（包含主机A未访问过的主机）都可以使用（222.123.12.23:50000)访问到主机A（192.168.0.123:4000）。

2. Restriced Cone Nat：限制锥形NAT（IP 限制），将内部的IP和端口映射到外部IP和端口，且无论目的地址是否相同，同一个内部的IP和端口会被映射为相同的外部IP和端口，只有访问过的外部主机IP可以通过映射后的IP和端口连接主机A。

   例如：主机A（192.168.0.123:4000）访问主机B（223.124.34.23:9000），A的IP将会被映射为（222.123.12.23:50000)；此时只有IP为（223.124.34.23）才能通过（222.123.12.23:50000）连接主机A。

3. Port Restricted Cone NAT：端口限制锥形 NAT（ IP+Port 限制），将内部的IP和端口映射到外部IP和端口，且无论目的地址是否相同，同一个内部的IP和端口会被映射为相同的外部IP和端口，只有访问过的外部主机IP和端口可以通过映射后的IP和端口连接主机A。

   例如：主机A（192.168.0.123:4000）访问主机B（223.124.34.23:9000），A的IP将会被映射为（222.123.12.23:50000)；此时只有IP为（223.124.34.23:9000）才能通过（222.123.12.23:50000）连接主机A。

4. Symmetric NAT：对称NAT，只有来自同一内部IP和端口，且发送到同一目的IP和端口，映射的外部IP和端口才会一致。

   例如：主机A（192.168.0.123:4000）访问主机B（223.124.34.23:9000），A的IP被映射为（222.123.12.23:50000)，并将这三个IP、端口进行绑定；等到主机A（192.168.0.123:4000）访问主机C时，可能（注意是可能，也有可能会不变）会被映射为（222.123.12.23:60010)，然后又会将这三个IP、端口绑定。

### Linux的NAT

IPtables主要可以实现的网络地址转换有SNAT、DNAT和MASQUERADE。SNAT是Source Network Address Translation的缩写，即源地址目标转换，需要指定转换后的IP。DNAT是Destination Network Address Translation的缩写，即目标网络地址转换。MASQUERADE，地址伪装，算是SNAT中的一种特例，可以实现自动化的SNAT，根据出口的IP地址进行转换。

Linux在进行地址转换时，会遵循两个原则：1.尽量不去修改源端口，也就是说，IP转换后的源端口尽可能保持不变；2.IP转换后必须保证转换后的源地址、端口与目标地址、端口（即所谓的socket ）唯一，否则响应包将不知道转发给谁。

假设如下的情况（ 内网有主机 A 和 D ，公网有主机 B 和 C ），先后建立如下三条连接：

```
A (1000) -> NAT (1000) -> B (2000)
D (1000) -> NAT (1000) -> C (2000)
A (1000) -> NAT (1001) -> C (2000)
```

**说明Linux的NAT是对称NAT。**

## DNS

Domain Name System（域名系统，也叫域名解析系统），帮助我们把域名解析为IP地址。一个域名必须对应一个IP地址，一个IP地址可以同时对应多个域名。

### 转发

当DNS服务器在收到DNS客户端的查询请求后，如果可以解析，则将解析结果返回，否则转发给其他的DNS服务器进行查询。

### 解析

当DNS服务器在收到DNS客户端的查询请求后，如果可以解析，则将解析结果返回，否则DNS服务器发送给根域名服务器；根域名服务器收到查询请求后，把所查询的域名中顶级域名所对应的顶级域名服务器地址返回给DNS服务器，以此类推，直到查询到所请求域名的IP。

### 常用记录类型

A记录：将域名指向一个IPv4地址。

AAAA记录：将域名指向一个IPv6地址。

CNAME记录：将域名指向另外一个域名。

### hosts文件

hosts文件就是本地域名信息和Ip地址信息的映射表，其解析优先级比DNS要高。

## 常见问题

### ping不通

防火墙拦截；对方路由表配置错误，响应包无法返回。